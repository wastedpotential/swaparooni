<!doctype html>
<html>
  <head>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <script src="assets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
    <style>
        html, body {
            position: relativ;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* prevent scrollbars */
        }
        .container {
            position: absolute;
        }
        .menu {
            position: absolute;
        }
    </style>
    <title>wasted potential</title>
  </head>
  <body>
      <div class="container"></div>
      <div class="menu">
          <button type="button" onclick="tweenIt()">Tweiner</button>
        </div>
    <script>
        // TODO - move everything to separate files
        // TODO - make code more functional
        // TODO: add timer to switch back to main site title after a short time
        function tweenIt() {
            for (let i=0; i<letters.length; i++) {
                if (letters[i].used) letters[i].used = false;
            }
            let ana = getAnagram(anagrams, currentPhrase);
            currentPhrase = showNewAnagram(ana);
            changePageTitle(ana);
        }

        function populateLetterArrays(str, objectArray) {
            const line = [];
            for (var i = 0; i < str.length; i++) {
                const nextLetter = str.charAt(i);
                const letterObj = objectArray.find(e => {
                    return !(e.used) && (e.char == nextLetter);
                });
                line.push(letterObj);
                letterObj.used = true;
            }
            return line;
        }

        function totalWidth(items) {
            var total = items.reduce(
                (partialSum, a) => partialSum + a.w, 0
            );
            return total;
        }
      
        function getLetterObjArray(stringArray, letterObjectsArray) {
            const lineArray = [];
            for (const str of stringArray) {
                lineArray.push(populateLetterArrays(str, letterObjectsArray));
            }
            return lineArray;
        }
      
        function calculateLetterObjPositions(lineArray, letterHeight) {
            const startY = -0.5 * lineArray.length * letterHeight;
            for (let i=0; i<lineArray.length; i++){
                const line = lineArray[i];
                const totalW = totalWidth(line);
                let lineX = -0.5 * totalW;
                const lineStartY = i * letterHeight + startY;
                for (let j=0; j<line.length; j++) {
                    const ltr = line[j];
                    ltr.destX = lineX;
                    ltr.destY = lineStartY;
                    lineX += line[j].w;
                }
            }
            return lineArray;
        }
        
        function changePageTitle(phrase) {
            const newTitle = phrase.split('\n').join(' ');
            document.title = newTitle;
        }
      
// ==================== VIEW STUFF =========================

        function swapLetters(lineArray, animated=true) {
            for (let i=0; i<letters.length; i++) { // TODO - change the style of for loop? everywhere?
                const ltr = letters[i];
                if (ltr.sprite) { // don't render spaces. duh.
                    if (animated) {
                        gsap.to(ltr.sprite, { x: ltr.destX, y: ltr.destY, duration: 0.3 });
                    } else {
                        ltr.sprite.position.x = ltr.destX;
                        ltr.sprite.position.y = ltr.destY;
                    }                
                }
            }
        }

        function isValidAnagram(basePhrase, anagram) {
            const str1 = basePhrase.split(' ').join('').split('\n').join('').split('').sort().join(''); 
            const str2 = anagram.split(' ').join('').split('\n').join('').split('').sort().join('');
            return (str1 === str2);
        }

        function getAnagram(anagrams, currentText) {
            let newAnagram;
            do {
                const ind = Math.floor(anagrams.length* Math.random());
                newAnagram = anagrams[ind];
            } while (newAnagram === currentText)
            return newAnagram;
        }
     
        function createLetterSprites(letterObjs) {
            for (let i=0; i<letterObjs.length; i++) {
                let letter = letterObjs[i];
                if (letter.id) {
                    const sprite = PIXI.Sprite.from(app.loader.resources[letter.id].texture, { roundPixels: true, resolution: devicePixelRatio }); // Magically load the PNG asynchronously
                    letter.sprite = sprite;
                    sprite.position.x = letter.destX;
                    sprite.position.y = letter.destY;
                    centerPoint.addChild(sprite);
                }            
            }
        }

        function onAppProgress(e) {
            // TODO
            console.log('loading:', e.progress);
        }

        function onAppError(e) {
            // TODO
            console.log('error:', e.message);
        }

        function onAppLoaded(e) {
            createLetterSprites(letters);        
        }

        window.addEventListener('resize', onResize);
        var app = new PIXI.Application({ autoResize:true, resolution: devicePixelRatio, roundPixels: true, backgroundColor: 0xf1f4f9 });
        const cont = document.querySelector('.container'); 
        cont.appendChild(app.view);
        var centerPoint = new PIXI.Container({resolution: devicePixelRatio, roundPixels: true});
        app.stage.addChild(centerPoint);

        // TODO: load all assets here
        app.loader.baseUrl = 'assets/letters/';
        for (const letter of letters) {
            if (letter.id) {
                app.loader.add(letter.id, letter.id + '_01@2x.png');
            }
        }
        app.loader.onProgress.add(onAppProgress);
        app.loader.onError.add(onAppError);
        app.loader.onComplete.add(onAppLoaded);
        app.loader.load();

        // TODO: fade in
    
        // start with "wasted potential":
        let currentPhrase = showNewAnagram(siteTitle);
        //currentPhrase);

        function showNewAnagram(anagram) {
            if (isValidAnagram(siteTitle, anagram)) { // error check // TODO - what if not valid?
                const lines = anagram.split('\n'); // split anagram into an array of "lines"
                const lineArray = getLetterObjArray(lines, letters); // prepare for positioning - put letter objects in proper order 
                const objectArray = calculateLetterObjPositions(lineArray, letterHeight); // prepare for positioning - calculate letter positions
                // TODO: this sucks. get rid of objectArray and only work with letters array
                swapLetters(objectArray, true);
            } else {
                console.log("INVALID ANAGRAM");
            }
        }

        function onResize() {	
            const w = window.innerWidth/devicePixelRatio;
            const h = window.innerHeight/devicePixelRatio;
            if (app) app.renderer.resize(w, h);
    
            if (centerPoint) {
                centerPoint.position.set(0.5 * w, 0.5 * h);
            }
        }
        onResize(); 
      
    </script>
  </body>
</html>