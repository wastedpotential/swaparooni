<!doctype html>
<html>
  <head>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <script src="assets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
    <style>
        html, body {
            position: relativ;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* prevent scrollbars */
        }
        .container {
            position: absolute;
        }
        .menu {
            position: absolute;
        }
    </style>
  </head>
  <body>
      <div class="container"></div>
      <div class="menu">
          <button type="button" onclick="swapText()">Herp Derp</button>
          <button type="button" onclick="tweenIt()">Tweiner</button>
        </div>
    <script>
        function tweenIt() {
            for (let i=0; i<sprites.length; i++) {
                const endPosX = Math.floor(window.innerWidth/devicePixelRatio * Math.random());
                const endPosY = Math.floor(window.innerHeight/devicePixelRatio * Math.random());
                gsap.to(sprites[i], { x: endPosX, y: endPosY, duration: 0.5 });
            }
        }
        const dupe = duplicateArray(letters);
            
        function swapText() {
            console.log("swap");
            const phrase = getRandomPhrase(anagrams);
            const lines = phrase.split('\n');
            const lineArray = getLetterObjArray(lines, dupe);
            const destPositions = calculateLetterObjPositions(lineArray, letterHeight);
            changePageTitle(phrase);
            changePositions(destPositions);
        }

        function duplicateArray(arrayOfObjects) { 
            const dupe = arrayOfObjects.map((obj) => {
                const newObj = {...obj}  
                return newObj;
            });
            return dupe;
        }

        function populateLetterArrays(str, objectArray) {
            // console.log('pop:', str, objectsRemaining);
            const line = [];
            for (var i = 0; i < str.length; i++) {
                const nextLetter = str.charAt(i);
                // TODO: if space, handle it here
                const letterObj = objectArray.find(e => {
                    return !(e.used) && (e.char == nextLetter);
                });
                console.log('letterObj:', letterObj);
                line.push(letterObj);
                letterObj.used = true;
            }
            console.log('herp:', line);
            return line;
        }

        function totalWidth(items) {
            var total = items.reduce(
                (partialSum, a) => partialSum + a.w, 0
            );
            return total;
        }

      
      function getRandomPhrase(phrases) {
        const ind = Math.floor(phrases.length* Math.random());
        const phrase = phrases[ind];
        // TODO: add a check that the anagram is valid
        // TODO: add a check that anagram is not the same as the one already showing
        return phrase;
      }
      
      function getLetterObjArray(stringArray, letterObjectsArray) {
        const lineArray = [];
        for (const str of stringArray) {
            //   console.log('line:', str);
            lineArray.push(populateLetterArrays(str, letterObjectsArray));
        }
        return lineArray;
      }
      
      function calculateLetterObjPositions(lineArray, letterHeight) {
        const startY = -0.5 * lineArray.length * letterHeight;
        for (let i=0; i<lineArray.length; i++){
            const line = lineArray[i];
            const totalW = totalWidth(line);
            console.log(i, line.length, totalW);
            let lineX = -0.5 * totalW;
            const lineStartY = i * letterHeight + startY;
            for (let j=0; j<line.length; j++) {
                const ltr = line[j];
                ltr.destX = lineX;
                ltr.destY = lineStartY;
                lineX += line[j].w;
            }
        }
        return lineArray;
      }

      
      function changePageTitle(phrase) {
          const newTitle = phrase.split('\n').join(' ');
          document.title = newTitle;
      }

      
// ==================== VIEW STUFF =========================

      let sprites = [];
    function changePositions(lineArray) {
        removeAllLettersFrom(centerPoint);
        sprites = [];
        for (let i=0; i<lineArray.length; i++) {
        const line = lineArray[i];
        for (let j=0; j<line.length; j++) {
            const ltr = line[j];
            if (ltr.img) { // don't render spaces. duh.
                let sprite = PIXI.Sprite.from(ltr.img); // Magically load the PNG asynchronously
                sprite.position.x = ltr.destX;
                sprite.position.y = ltr.destY;
                centerPoint.addChild(sprite);
                sprites.push(sprite);
            }
        }
      }
    }

    function removeAllLettersFrom(displayObject) {
        for (var i = displayObject.children.length - 1; i >= 0; i--) {	
            displayObject.removeChild(displayObject.children[i]);
        };
    }
     
    function onResize() {	
        const w = window.innerWidth/devicePixelRatio;
        const h = window.innerHeight/devicePixelRatio;
        app.renderer.resize(w, h);
  
        if (centerPoint) {
            centerPoint.position.set(0.5 * w, 0.5 * h);
        }
    }

    window.addEventListener('resize', onResize);

    let app = new PIXI.Application({ resolution: devicePixelRatio });
    const cont = document.querySelector('.container'); 
    cont.appendChild(app.view);
    const centerPoint = new PIXI.Container();
    app.stage.addChild(centerPoint);

      onResize();
    </script>
  </body>
</html>