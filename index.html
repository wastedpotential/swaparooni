<!doctype html>
<html>
  <head>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <script src="assets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
    <style>
        html, body {
            position: relativ;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* prevent scrollbars */
        }
        .container {
            position: absolute;
        }
        .menu {
            position: absolute;
        }
    </style>
  </head>
  <body>
      <div class="container"></div>
      <div class="menu">
          <button type="button" onclick="swapText()">Herp Derp</button>
          <button type="button" onclick="tweenIt()">Tweiner</button>
        </div>
    <script>
        function tweenIt() {
            for (let i=0; i<letters.length; i++) {
                if (letters[i].used) letters[i].used = false;
            }
            let ana = getAnagram(anagrams, currentPhrase);
            showNewAnagram(ana);
            // for (let i=0; i<sprites.length; i++) {
            //     const endPosX = Math.floor(window.innerWidth/devicePixelRatio * Math.random());
            //     const endPosY = Math.floor(window.innerHeight/devicePixelRatio * Math.random());
            //     gsap.to(sprites[i], { x: endPosX, y: endPosY, duration: 0.5 });
            // }
        }
        // const dupe = duplicateArray(letters);
            
        // function swapText() {
        //     console.log("swap");
        //     const phrase = getRandomPhrase(anagrams);
        //     const lines = phrase.split('\n');
        //     const lineArray = getLetterObjArray(lines, dupe);
        //     const destPositions = calculateLetterObjPositions(lineArray, letterHeight);
        //     changePageTitle(phrase);
        //     swapLetters(destPositions);
        // }

        // function duplicateArray(arrayOfObjects) { 
        //     const dupe = arrayOfObjects.map((obj) => {
        //         const newObj = {...obj}  
        //         return newObj;
        //     });
        //     return dupe;
        // }

        function populateLetterArrays(str, objectArray) {
            console.log('pop:', str, objectArray);
            const line = [];
            for (var i = 0; i < str.length; i++) {
                const nextLetter = str.charAt(i);
                // TODO: if space, handle it here
                console.log("nextLEtter:", nextLetter);
                const letterObj = objectArray.find(e => {
                    return !(e.used) && (e.char == nextLetter);
                });
                console.log('letterObj:', letterObj);
                line.push(letterObj);
                letterObj.used = true;
            }
            console.log('herp:', line);
            return line;
        }

        function totalWidth(items) {
            var total = items.reduce(
                (partialSum, a) => partialSum + a.w, 0
            );
            return total;
        }

      
    //   function getRandomPhrase(phrases) {
    //     const ind = Math.floor(phrases.length* Math.random());
    //     const phrase = phrases[ind];
    //     // TODO: add a check that the anagram is valid
    //     // TODO: add a check that anagram is not the same as the one already showing
    //     return phrase;
    //   }
      
      function getLetterObjArray(stringArray, letterObjectsArray) {
        const lineArray = [];
        for (const str of stringArray) {
            //   console.log('line:', str);
            lineArray.push(populateLetterArrays(str, letterObjectsArray));
        }
        return lineArray;
      }
      
      function calculateLetterObjPositions(lineArray, letterHeight) {
        const startY = -0.5 * lineArray.length * letterHeight;
        for (let i=0; i<lineArray.length; i++){
            const line = lineArray[i];
            const totalW = totalWidth(line);
            console.log(i, line.length, totalW);
            let lineX = -0.5 * totalW;
            const lineStartY = i * letterHeight + startY;
            for (let j=0; j<line.length; j++) {
                const ltr = line[j];
                ltr.destX = lineX;
                ltr.destY = lineStartY;
                lineX += line[j].w;
            }
        }
        return lineArray;
      }

      
      function changePageTitle(phrase) {
          const newTitle = phrase.split('\n').join(' ');
          document.title = newTitle;
      }

      
// ==================== VIEW STUFF =========================

      let sprites = [];
    function swapLetters(lineArray, animated=true) {
        // removeAllLettersFrom(centerPoint);
        // sprites = [];
        // for (let i=0; i<lineArray.length; i++) {
        // const line = lineArray[i];
        for (let i=0; i<letters.length; i++) {
            const ltr = letters[i];
            if (ltr.sprite) { // don't render spaces. duh.
                if (animated) {
                    // const endPosX = Math.floor(window.innerWidth/devicePixelRatio * Math.random());
                    // const endPosY = Math.floor(window.innerHeight/devicePixelRatio * Math.random());
                    gsap.to(ltr.sprite, { x: ltr.destX, y: ltr.destY, duration: 0.3 });
                } else {
                    ltr.sprite.position.x = ltr.destX;
                    ltr.sprite.position.y = ltr.destY;
                }                
            }
        }
    //   }
    }

    // function removeAllLettersFrom(displayObject) {
    //     for (var i = displayObject.children.length - 1; i >= 0; i--) {	
    //         displayObject.removeChild(displayObject.children[i]);
    //     };
    // }



    function isValidAnagram(basePhrase, anagram) {
        // Inbuilt functions to rearrange the string
        const str1 = basePhrase.split(' ').join('').split('\n').join('').split('').sort().join(''); 
        const str2 = anagram.split(' ').join('').split('\n').join('').split('').sort().join('');
        return (str1 === str2);
    }

    function getAnagram(anagrams, currentText) {
        let newAnagram;
        do {
            const ind = Math.floor(anagrams.length* Math.random());
            newAnagram = anagrams[ind];
            console.log('~~~', newAnagram);
        } while (newAnagram === currentText)
        return newAnagram;
    }
     
    function onResize() {	
        const w = window.innerWidth/devicePixelRatio;
        const h = window.innerHeight/devicePixelRatio;
        if (app) app.renderer.resize(w, h);
  
        if (centerPoint) {
            centerPoint.position.set(0.5 * w, 0.5 * h);
        }
    }
    onResize();

function createLetterSprites(letterObjs) {
    console.log('createLetterSprites:', letterObjs);
    for (let i=0; i<letterObjs.length; i++) {
        let letter = letterObjs[i];
        console.log(letter);
        if (letter.id) {
            console.log("sprite me:",letter.id);
            const sprite = PIXI.Sprite.from(app.loader.resources[letter.id].texture); // Magically load the PNG asynchronously
            letter.sprite = sprite;
            sprite.position.x = letter.destX;
            sprite.position.y = letter.destY;
            centerPoint.addChild(sprite);
        }            
    }
}

    function onAppProgress(e) {
        console.log('loading:', e.progress);
    }

    function onAppError(e) {
        console.log('error:', e.message);
    }

    function onAppLoaded(e) {
        console.log('LOADED!!!');
        console.log(letters);
        createLetterSprites(letters);        
    }

    window.addEventListener('resize', onResize);
    var app = new PIXI.Application({ resolution: devicePixelRatio });
    const cont = document.querySelector('.container'); 
    cont.appendChild(app.view);
    var centerPoint = new PIXI.Container();
    app.stage.addChild(centerPoint);

    let currentPhrase = siteTitle;

    // TODO: load all assets here
    app.loader.baseUrl = 'assets/';
    for (const letter of letters) {
        if (letter.id) {
            console.log(letter.id);
            app.loader.add(letter.id, letter.id + '.png');
        }
    }
    app.loader.onProgress.add(onAppProgress);
    app.loader.onError.add(onAppError);
    app.loader.onComplete.add(onAppLoaded);
    console.log('start laod');
    app.loader.load();

    // TODO: fade in
    
    let ana = siteTitle;
    showNewAnagram(ana);

    function showNewAnagram(anagram) {
        if (isValidAnagram(siteTitle, anagram)) { // error check
            const lines = anagram.split('\n'); // split anagram into an array of "lines"
            const lineArray = getLetterObjArray(lines, letters); // prepare for positioning - put letter objects in proper order 
            const objectArray = calculateLetterObjPositions(lineArray, letterHeight); // prepare for positioning - calculate letter positions
            // TODO: this sucks. get rid of objectArray and only work with letters array
            swapLetters(objectArray, true);
        }
    }
      
    </script>
  </body>
</html>